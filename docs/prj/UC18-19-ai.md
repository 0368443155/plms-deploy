# ğŸ¤– UC18-UC19: INTELLIGENT FEATURES (AI)

## ğŸ“‹ Má»¥c lá»¥c
1. [Tá»•ng quan](#1-tá»•ng-quan)
2. [Chiáº¿n lÆ°á»£c AI Ä‘a táº§ng (Multi-Tier AI Strategy)](#2-chiáº¿n-lÆ°á»£c-ai-Ä‘a-táº§ng-multi-tier-ai-strategy)
3. [UC18: TÃ³m táº¯t tÃ i liá»‡u (AI Summary)](#3-uc18-tÃ³m-táº¯t-tÃ i-liá»‡u-ai-summary)
4. [UC19: Chat vá»›i tÃ i liá»‡u (RAG Basic)](#4-uc19-chat-vá»›i-tÃ i-liá»‡u-rag-basic)

---

## 1. Tá»•ng quan

PLMS tÃ­ch há»£p AI Ä‘á»ƒ há»— trá»£ há»c táº­p thÃ´ng qua 2 tÃ­nh nÄƒng chÃ­nh:
- **TÃ³m táº¯t ná»™i dung**: GiÃºp sinh viÃªn náº¯m báº¯t nhanh Ã½ chÃ­nh cá»§a bÃ i ghi chÃº dÃ i.
- **Há»i Ä‘Ã¡p (Chat)**: TÆ°Æ¡ng tÃ¡c vá»›i ná»™i dung bÃ i há»c nhÆ° má»™t trá»£ lÃ½ gia sÆ°.

TÃ­nh nÄƒng nÃ y Ä‘Æ°á»£c xá»­ lÃ½ thÃ´ng qua `Convex Actions` Ä‘á»ƒ gá»i tá»›i cÃ¡c API bÃªn ngoÃ i mÃ  khÃ´ng lÃ m cháº·n luá»“ng chÃ­nh.

---

## 2. Chiáº¿n lÆ°á»£c AI Ä‘a táº§ng (Multi-Tier AI Strategy)

Äá»ƒ Ä‘áº£m báº£o dá»‹ch vá»¥ luÃ´n hoáº¡t Ä‘á»™ng vÃ  tá»‘i Æ°u chi phÃ­, chÃºng tÃ´i triá»ƒn khai chiáº¿n lÆ°á»£c "Fallback" (dá»± phÃ²ng) 2 táº§ng.

| Táº§ng (Tier) | Provider | Model | Äáº·c Ä‘iá»ƒm |
|-------------|----------|-------|----------|
| **Primary** | **SambaNova** | `Meta-Llama-3.1-8B-Instruct` | Tá»‘c Ä‘á»™ cá»±c nhanh, cháº¥t lÆ°á»£ng cao, API Free Tier ($5 credit). |
| **Fallback** | **Hugging Face** | `Facebook-BART-Large-CNN` <br> `DialoGPT` | Miá»…n phÃ­ hoÃ n toÃ n, khÃ´ng cáº§n credit card, nhÆ°ng cháº­m hÆ¡n vÃ  Ä‘Ã´i khi quÃ¡ táº£i (503). |

### 2.1 Logic chuyá»ƒn Ä‘á»•i (Failover)

```typescript
// convex/ai.ts
try {
  // 1. Thá»­ gá»i SambaNova
  return await summarizeWithSambaNova(text, key);
} catch (e) {
  console.log("SambaNova lá»—i, chuyá»ƒn sang Hugging Face...");
  
  // 2. Fallback sang Hugging Face
  try {
    return await summarizeWithHuggingFace(text);
  } catch (e2) {
    throw new Error("Táº¥t cáº£ há»‡ thá»‘ng AI Ä‘á»u báº­n.");
  }
}
```

---

## 3. UC18: TÃ³m táº¯t tÃ i liá»‡u (AI Summary)

### 3.1 Quy trÃ¬nh xá»­ lÃ½

1. **Extraction**: TrÃ­ch xuáº¥t text thuáº§n tá»« BlockNote JSON (loáº¡i bá» format JSON).
2. **Hashing**: Táº¡o hash tá»« ná»™i dung text Ä‘á»ƒ lÃ m key cache.
3. **Cache Check**: Kiá»ƒm tra trong báº£ng `aiSummaries`. Náº¿u trÃ¹ng hash -> Tráº£ vá» cache (Ä‘á»¡ tá»‘n API).
4. **Generation**: Náº¿u chÆ°a cÃ³ cache, gá»i AI API.
5. **Caching**: LÆ°u káº¿t quáº£ má»›i vÃ o DB.

### 3.2 Database Schema (Cache)

```typescript
aiSummaries: defineTable({
  documentId: v.id("documents"),
  userId: v.string(),
  summary: v.string(),
  contentHash: v.string(),  // Hash MD5/Simple cá»§a ná»™i dung gá»‘c
  model: v.string(),        // Model Ä‘Ã£ dÃ¹ng (Ä‘á»ƒ tracking)
  createdAt: v.number(),
}).index("by_document_hash", ["documentId", "contentHash"]),
```

### 3.3 Thuáº­t toÃ¡n Hash Content

VÃ¬ Convex khÃ´ng cÃ³ thÆ° viá»‡n Crypto Ä‘áº§y Ä‘á»§, chÃºng tÃ´i dÃ¹ng thuáº­t toÃ¡n hash Ä‘Æ¡n giáº£n Ä‘á»ƒ nháº­n biáº¿t sá»± thay Ä‘á»•i ná»™i dung:

```typescript
function hashContent(content: string): string {
  let hash = 0;
  for (let i = 0; i < content.length; i++) {
    const char = content.charCodeAt(i);
    hash = (hash << 5) - hash + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36);
}
```

---

## 4. UC19: Chat vá»›i tÃ i liá»‡u (RAG Basic)

TÃ­nh nÄƒng nÃ y sá»­ dá»¥ng ká»¹ thuáº­t **RAG (Retrieval-Augmented Generation)** á»Ÿ má»©c cÆ¡ báº£n: ÄÆ°a context tÃ i liá»‡u vÃ o prompt.

### 4.1 Prompt Engineering

ChÃºng tÃ´i xÃ¢y dá»±ng System Prompt Ä‘á»ƒ Ä‘á»‹nh hÆ°á»›ng AI:

```typescript
const systemPrompt = `Báº¡n lÃ  má»™t trá»£ lÃ½ AI chuyÃªn tráº£ lá»i cÃ¢u há»i dá»±a trÃªn ná»™i dung tÃ i liá»‡u. 
HÃ£y tráº£ lá»i cÃ¢u há»i má»™t cÃ¡ch chÃ­nh xÃ¡c vÃ  há»¯u Ã­ch dá»±a trÃªn ná»™i dung tÃ i liá»‡u sau:

${documentContext.substring(0, 2000)} ...`;
```

*LÆ°u Ã½: Do giá»›i háº¡n context window cá»§a cÃ¡c model miá»…n phÃ­, chÃºng tÃ´i cáº¯t context á»Ÿ má»©c 2000-8000 kÃ½ tá»±.*

### 4.2 LÆ°u trá»¯ lá»‹ch sá»­ chat

Äá»ƒ AI nhá»› ngá»¯ cáº£nh cuá»™c trÃ² chuyá»‡n, chÃºng tÃ´i lÆ°u messages vÃ o báº£ng `chatMessages`.

```typescript
// Gá»­i máº£ng message history lÃªn API
const messages = [
  { role: "system", content: systemPrompt },
  ...limitHistory.map(msg => ({ 
    role: msg.role, 
    content: msg.content 
  })),
  { role: "user", content: newMessage }
];
```

Äiá»u nÃ y giÃºp ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ há»i "CÃ¡i Ä‘Ã³ nghÄ©a lÃ  gÃ¬?" (reference láº¡i cÃ¢u trÆ°á»›c Ä‘Ã³) mÃ  AI váº«n hiá»ƒu Ä‘Æ°á»£c.

---
*Cáº­p nháº­t láº§n cuá»‘i: 26/12/2024*
